<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>チーム対応タスク管理（単一HTML）</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f7f9; color:#111; }
    .container{ max-width:1100px; margin:0 auto; padding:16px; }
    .card{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row{ display:flex; flex-wrap:wrap; gap:12px; }
    .col{ flex:1 1 200px; }
    .input, select, textarea{ width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .btn{ padding:8px 14px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .task{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; margin-bottom:12px; }
    .title-btn{ border:none; background:none; font-weight:bold; font-size:16px; cursor:pointer; }
    .check{ appearance:none; width:20px; height:20px; border:2px solid #ccc; border-radius:4px; margin-right:8px; cursor:pointer; display:inline-block; text-align:center; }
    .check.done{ background:#16a34a; border-color:#16a34a; color:#fff; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:grid; place-items:center; }
    .modal .panel{ background:#fff; padding:20px; border-radius:12px; max-width:400px; }
  </style>
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>チーム対応タスク管理</h2>
      <div class="row">
        <div class="col"><label>タイトル</label><input id="qTitle" class="input"></div>
        <div class="col"><label>期限</label><input id="qDue" type="date" class="input"></div>
        <div class="col"><label>担当者</label><input id="qAssignee" class="input"></div>
        <div class="col"><label>優先度</label>
          <select id="qPriority" class="input"><option>高</option><option>中</option><option>低</option></select>
        </div>
        <div class="col"><label>ステータス</label>
          <select id="qStatus" class="input"><option>Non touch</option><option>Doing</option><option>Passed</option></select>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button class="btn primary" id="addBtn">追加（Shift+Enter）</button>
      </div>
    </div>

    <div class="card">
      <h3>Googleカレンダー連携</h3>
      <div class="row">
        <div class="col"><label>API Key</label><input id="apiKey" class="input"></div>
        <div class="col"><label>OAuth Client ID</label><input id="clientId" class="input"></div>
      </div>
      <div style="margin-top:8px;">
        <button class="btn" id="initBtn">初期化</button>
        <button class="btn primary" id="signInBtn">Googleでサインイン</button>
        <button class="btn" id="calFetchBtn">カレンダー取得</button>
      </div>
      <div id="calList" style="margin-top:8px;"></div>
    </div>

    <div id="list"></div>
  </div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  let tasks=[];
  const listEl=$('list');

  function render(){
    listEl.innerHTML='';
    tasks.forEach(t=>{
      const wrap=document.createElement('div');
      wrap.className='task';
      const check=document.createElement('div');
      check.className='check'+(t.completed?' done':'');
      check.innerHTML=t.completed?'✓':'';
      check.onclick=()=>confirmComplete(()=>{t.completed=true; render();});
      const btn=document.createElement('button');
      btn.className='title-btn'; btn.textContent=t.title;
      wrap.appendChild(check); wrap.appendChild(btn);
      listEl.appendChild(wrap);
    });
  }

  function confirmComplete(onOK){
    const dlg=document.createElement('div'); dlg.className='modal';
    dlg.innerHTML=`<div class="panel"><p>タスクを完了させますが良いですか？</p>
      <button class="btn" id="ccCancel">キャンセル</button>
      <button class="btn primary" id="ccOK">OK</button></div>`;
    document.body.appendChild(dlg);
    $('ccCancel').onclick=()=>dlg.remove();
    $('ccOK').onclick=()=>{onOK(); dlg.remove();};
  }

  $('addBtn').onclick=()=>{
    const title=$('qTitle').value.trim(); if(!title)return;
    if(!$('qDue').value){alert('期限は必須です');return;}
    tasks.push({title, due:$('qDue').value, assignee:$('qAssignee').value, priority:$('qPriority').value, status:$('qStatus').value, completed:false});
    $('qTitle').value=''; $('qDue').value=''; $('qAssignee').value='';
    render();
  };
  $('qTitle').addEventListener('keydown',e=>{ if(e.key==='Enter' && e.shiftKey){ $('addBtn').click(); }});

  // Google API init
  let gapiInited=false;
  $('initBtn').onclick=async()=>{
    const apiKey=$('apiKey').value.trim(); const clientId=$('clientId').value.trim();
    if(!apiKey||!clientId){alert('API KeyとClient IDを入力してください');return;}
    try{
      await new Promise(res=>gapi.load('client:auth2',res));
      await gapi.client.init({apiKey,clientId,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],scope:'https://www.googleapis.com/auth/calendar.events'});
      gapiInited=true; alert('初期化完了');
    }catch(e){alert('初期化失敗:'+e.message);}
  };
  $('signInBtn').onclick=async()=>{
    if(!gapiInited)return alert('先に初期化してください');
    await gapi.auth2.getAuthInstance().signIn();
    alert('サインインしました');
  };
  $('calFetchBtn').onclick=async()=>{
    if(!gapiInited)return alert('先に初期化してください');
    const res=await gapi.client.calendar.calendarList.list();
    $('calList').innerText=JSON.stringify(res.result.items.map(i=>i.summary));
  };
})();
</script>
</body>
</html>
